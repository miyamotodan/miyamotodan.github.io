<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Misuratore di Distanze</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <!-- Toolbar principale -->
    <nav class="navbar navbar-expand-xl navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0">
                <i class="fas fa-ruler"></i> <span class="d-none d-sm-inline">Misuratore Distanze</span>
            </span>

            <!-- Toggler per mobile -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarControls">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Toolbar controls -->
            <div class="collapse navbar-collapse" id="navbarControls">
            <div class="navbar-nav ms-auto d-flex flex-row flex-wrap gap-1 gap-xl-2 mt-2 mt-xl-0">
                <!-- 1. FILE/IMMAGINE -->
                <div class="nav-item">
                    <input type="file" id="upload" accept="image/*" class="d-none">
                    <label for="upload" class="btn btn-outline-light btn-sm mb-0">
                        <i class="fas fa-upload"></i> <span class="d-none d-md-inline">Carica</span>
                    </label>
                </div>

                <!-- Separatore visivo -->
                <div class="vr bg-light opacity-25 d-none d-xl-block"></div>

                <!-- 2. MODALITÀ -->
                <div class="nav-item">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-light" id="mode-select" title="Modalità Selezione">
                            <i class="fas fa-mouse-pointer"></i>
                        </button>
                        <button class="btn btn-outline-light active" id="mode-segment" title="Modalità Segmento">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="btn btn-outline-light" id="mode-continuous" title="Modalità Segmento Continuativo">
                            <i class="fas fa-wave-square"></i>
                        </button>
                        <button class="btn btn-outline-light" id="mode-rectangle" title="Modalità Rettangolo">
                            <i class="fas fa-square"></i>
                        </button>
                    </div>
                </div>

                <div class="nav-item">
                    <button class="btn btn-outline-light btn-sm" id="cancel-drawing" title="Annulla Disegno (ESC)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Separatore visivo -->
                <div class="vr bg-light opacity-25 d-none d-xl-block"></div>

                <!-- 3. VISUALIZZAZIONE -->
                <div class="nav-item">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-light active" id="toggle-segments" title="Mostra/Nascondi Segmenti">
                            <i class="fas fa-ruler-combined"></i>
                        </button>
                        <button class="btn btn-outline-light active" id="toggle-preview" title="Mostra/Nascondi Anteprima">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <!-- Separatore visivo -->
                <div class="vr bg-light opacity-25 d-none d-xl-block"></div>

                <!-- 4. NAVIGAZIONE -->
                <div class="nav-item">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-light" id="zoom-out" title="Zoom Out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="btn btn-outline-light" id="zoom-in" title="Zoom In">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="btn btn-outline-light" id="reset" title="Reset Vista">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Separatore visivo -->
                <div class="vr bg-light opacity-25 d-none d-xl-block"></div>

                <!-- 5. GESTIONE SEGMENTI -->
                <div class="nav-item">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-light" id="undo-btn" title="Annulla ultimo segmento (Ctrl+Z)">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="btn btn-outline-light" id="deleteall" title="Elimina tutti i segmenti">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- Separatore visivo -->
                <div class="vr bg-light opacity-25 d-none d-xl-block"></div>

                <!-- 6. TEMI -->
                <div class="nav-item">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-light" id="theme-light" title="Tema Chiaro">
                            <i class="fas fa-sun"></i>
                        </button>
                        <button class="btn btn-outline-light active" id="theme-dark" title="Tema Scuro">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button class="btn btn-outline-light" id="theme-contrast" title="Alto Contrasto">
                            <i class="fas fa-adjust"></i>
                        </button>
                    </div>
                </div>

                <!-- Separatore visivo -->
                <div class="vr bg-light opacity-25 d-none d-xl-block"></div>

                <!-- 7. SISTEMA -->
                <div class="nav-item">
                    <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#settingsPanel" title="Impostazioni">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>

                <div class="nav-item">
                    <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#debugModal" title="Debug">
                        <i class="fas fa-bug"></i>
                    </button>
                </div>

                <div class="nav-item">
                    <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#helpModal" title="Aiuto">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>

                <div class="nav-item">
                    <button class="btn btn-outline-light btn-sm" id="feedback-btn" title="Lascia un Feedback">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
            </div>
            </div>
        </div>
    </nav>

    <!-- Area canvas principale -->
    <div class="canvas-container position-relative">
        <canvas id="canvas"></canvas>
        
        <!-- Overlay per feedback visivo -->
        <div id="canvas-overlay">
            <div id="crosshair" class="crosshair"></div>
            <div id="touch-indicator" class="touch-indicator"></div>
        </div>
        
    </div>

    <!-- Pannello impostazioni (Offcanvas) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="settingsPanel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Impostazioni</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            
            <!-- Configurazione scala -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-ruler-horizontal"></i> Configurazione Scala
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Segmento selezionato</label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="pixelsel" disabled class="form-control" placeholder="Seleziona un segmento">
                            <span class="input-group-text">px</span>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="form-label">Riferimento (px)</label>
                            <input type="number" id="scale" value="" class="form-control" step="0.1" placeholder="Es. 250">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Misura reale (mm)</label>
                            <input type="number" id="real" value="" class="form-control" step="0.1" placeholder="Es. 200">
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" id="set-reference-btn">
                            <i class="fas fa-check me-1"></i> Applica rapporto di scala
                        </button>
                        <small class="text-muted">Inserisci pixel e mm, poi clicca per applicare il rapporto a tutti i segmenti</small>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Misura calcolata</label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="realsel" disabled class="form-control" placeholder="Nessun segmento selezionato">
                            <span class="input-group-text">mm</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista segmenti -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-list"></i> Misure Effettuate
                    </h6>
                    <span class="badge bg-secondary" id="segments-count">0</span>
                </div>
                <div class="card-body p-0">
                    <div id="segments-list" class="list-group list-group-flush">
                        <div class="list-group-item text-muted text-center">
                            Nessun segmento creato
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060;">
        <div id="info-toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">Info</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-body">
                <!-- Contenuto del toast -->
            </div>
        </div>
    </div>
    
    <!-- Status bar -->
    <div class="position-fixed bottom-0 start-0 w-100 bg-dark text-light py-1 px-3" style="z-index: 1050; font-size: 0.875rem;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span id="zoom-level">Zoom: 100%</span>
                <span class="mx-2">|</span>
                <span id="current-measurement">Nessuna selezione</span>
            </div>
            <div>
                <span id="segments-status">0 misure</span>
            </div>
        </div>
    </div>

    <!-- Modale Help & Credits -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-question-circle me-2"></i>Guida & Informazioni
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Manuale d'uso -->
                    <section class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-book me-2"></i>Manuale d'Uso
                        </h5>
                        <p class="lead">
                            <strong>ImgMeasure</strong> è un'applicazione web progettata per aiutare disegnatori, artigiani e chiunque abbia bisogno di prendere misure precise da un'immagine. L'applicazione consente di caricare un'immagine, definire una scala di riferimento e misurare distanze in millimetri.
                        </p>

                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-upload me-2"></i><strong>1. Carica un'Immagine</strong>
                            </div>
                            <div class="card-body">
                                Clicca sul pulsante <span class="badge bg-secondary">Carica</span> e seleziona un file dal tuo dispositivo.
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-ruler me-2"></i><strong>2. Imposta la Scala (Opzionale ma Raccomandato)</strong>
                            </div>
                            <div class="card-body">
                                <ol class="mb-0">
                                    <li>Disegna un primo segmento su un oggetto di cui conosci la lunghezza reale.</li>
                                    <li>Nelle <strong>Impostazioni</strong> (icona <i class="fas fa-cog"></i>), inserisci la lunghezza in pixel del segmento (che l'app compila in automatico nel campo `Riferimento (px)`) e la sua lunghezza reale in millimetri nel campo `Misura reale (mm)`.</li>
                                    <li>Clicca su "Applica rapporto di scala". Tutte le misure successive saranno mostrate in millimetri.</li>
                                </ol>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-drafting-compass me-2"></i><strong>3. Disegna i Segmenti</strong>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Seleziona una delle modalità di disegno dalla toolbar:</p>
                                <ul class="mb-0">
                                    <li><i class="fas fa-minus text-primary me-2"></i><strong>Segmento Singolo:</strong> Clicca due volte per creare una linea di misura singola.</li>
                                    <li><i class="fas fa-wave-square text-primary me-2"></i><strong>Segmento Continuo:</strong> Crea segmenti consecutivi - ogni punto finale diventa l'inizio del successivo (ideale per polilinee e percorsi).</li>
                                    <li><i class="fas fa-square text-primary me-2"></i><strong>Rettangolo:</strong> Clicca due vertici opposti per creare un rettangolo (4 segmenti) - utile per misurare larghezza e altezza simultaneamente.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-list me-2"></i><strong>4. Gestisci le Misure</strong>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Le misure create appariranno nella lista "Misure Effettuate" nel pannello <strong>Impostazioni</strong> (icona <i class="fas fa-cog"></i>).</p>
                                <ul class="mb-0">
                                    <li>Puoi cliccare su un segmento nella lista o sull'immagine per selezionarlo, visualizzarne i dettagli e rinominarlo.</li>
                                    <li>Usa i pulsanti <i class="fas fa-trash"></i> nella lista per eliminare i segmenti.</li>
                                    <li>Il pulsante <i class="fas fa-undo"></i> nella toolbar annulla l'ultimo segmento creato.</li>
                                    <li>Il pulsante <i class="fas fa-trash"></i> (accanto a undo) elimina tutti i segmenti.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-eye me-2"></i><strong>5. Visualizzazione e Anteprima</strong>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Controlla la visualizzazione con i pulsanti nella toolbar:</p>
                                <ul class="mb-0">
                                    <li><i class="fas fa-ruler-combined text-primary me-2"></i><strong>Mostra/Nascondi Segmenti:</strong> Attiva/disattiva la visibilità di tutti i segmenti.</li>
                                    <li><i class="fas fa-eye text-primary me-2"></i><strong>Mostra/Nascondi Anteprima:</strong> Attiva/disattiva l'anteprima in tempo reale mentre disegni.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-search me-2"></i><strong>6. Zoom e Navigazione</strong>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Naviga nell'immagine:</p>
                                <ul class="mb-0">
                                    <li><strong>Desktop:</strong> Tasto destro del mouse + trascina per spostare (pan), rotellina del mouse per zoom, o usa i pulsanti <i class="fas fa-search-plus"></i>/<i class="fas fa-search-minus"></i> nella toolbar.</li>
                                    <li><strong>Touch:</strong> Un dito per spostare (pan), pinch-to-zoom con due dita per lo zoom, doppio tap per resettare la vista.</li>
                                    <li>Il pulsante <i class="fas fa-expand-arrows-alt"></i> nella toolbar resetta la vista (zoom e posizione).</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-magnet me-2"></i><strong>7. Aggancio Automatico (Snap)</strong>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Quando clicchi vicino a un punto esistente (entro una certa tolleranza), il nuovo punto si aggancia automaticamente all'endpoint per massima precisione.</p>
                                <p class="mb-2"><strong>Indicatore visivo:</strong> Un cerchio pulsante appare quando il cursore è vicino a un punto agganciabile.</p>
                                <p class="mb-0"><strong>Utile per:</strong> Chiudere forme, creare percorsi continui precisi, connettere misure multiple.</p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-keyboard me-2"></i><strong>8. Scorciatoie da Tastiera</strong>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    <li><kbd>ESC</kbd>: Annulla il disegno corrente (utile in modalità continuativa per terminare la catena).</li>
                                    <li><kbd>Ctrl + Z</kbd> (o <kbd>Cmd + Z</kbd> su Mac): Annulla l'ultimo segmento creato.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-palette me-2"></i><strong>9. Temi Personalizzabili</strong>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Scegli tra 3 temi dalla toolbar per migliorare la visibilità:</p>
                                <ul class="mb-0">
                                    <li><i class="fas fa-sun text-warning me-2"></i><strong>Chiaro</strong></li>
                                    <li><i class="fas fa-moon text-info me-2"></i><strong>Scuro</strong> (predefinito)</li>
                                    <li><i class="fas fa-adjust me-2"></i><strong>Alto Contrasto</strong></li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <hr class="my-4">

                    <!-- Credits & Donazioni -->
                    <section class="text-center">
                        
                        <p>
                            <strong>ImgMeasure</strong> è un software <strong>gratuito e open source</strong> sviluppato per aiutare artisti, artigiani e creativi nel loro lavoro.
                        </p>

                        <div class="mt-4">
                            <p class="small text-muted mb-1">
                                <i class="fas fa-code me-2"></i>Sviluppato con <i class="fas fa-heart text-danger"></i> per la comunità creativa
                            </p>
                            <p class="small text-muted mb-1">
                                © 2024 ImgMeasure - Licenza Open Source
                            </p>
                            <p class="small text-muted">
                                Versione 1.0.11 debug
                            </p>
                        </div>
                    </section>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Modal -->
    <div class="modal fade" id="debugModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-bug me-2"></i>Debug Log
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <button class="btn btn-sm btn-danger" id="clear-debug-log">
                            <i class="fas fa-trash me-1"></i>Pulisci Log
                        </button>
                    </div>
                    <div id="debug-log" style="font-family: monospace; font-size: 0.85rem; max-height: 500px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <div class="text-muted">Log eventi pronto...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Feedback -->
    <div class="modal fade" id="feedbackModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-heart me-2"></i>Ti sta piacendo ImgMeasure?
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="lead mb-4">Il tuo feedback è prezioso per migliorare l'app!</p>
                    <p class="text-muted mb-4">
                        Condividi la tua esperienza, suggerimenti o segnala problemi su GitHub.
                    </p>
                    <div class="d-grid gap-2">
                        <a href="https://github.com/miyamotodan/imgmeasure/issues/new?labels=feedback&template=feedback.md&title=[Feedback]%20"
                           target="_blank"
                           class="btn btn-primary btn-lg"
                           id="feedback-yes-btn">
                            <i class="fab fa-github me-2"></i>Lascia un Feedback
                        </a>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="feedback-later-btn">
                            Magari dopo
                        </button>
                        <button type="button" class="btn btn-link text-muted" id="feedback-never-btn">
                            Non mostrare più
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modali per conferme -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">Conferma</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body">
                    Sei sicuro di voler procedere?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-danger btn-sm" id="confirm-action">Conferma</button>
                </div>
            </div>
        </div>
    </div>

    <script src="bootstrap.bundle.min.js"></script>
    <script src="main.js"></script>

</body>

</html>